name: Test Microceph Action

on:
  push:
  pull_request:

jobs:
  linting:
    runs-on: ubuntu-latest
    name: Linting
    steps:
      - name: Checkout repo
        uses: actions/checkout@v3
        with:
          fetch-depth: 0
      - name: Lint
        run: |
          sudo apt install -qq -y python3 python3-yaml
          shellcheck *.sh
          python3 -c "import yaml; yaml.safe_load(open('action.yml').read())"

  testing:
    runs-on: ubuntu-latest
    name: Testing
    steps:
      - name: Checkout repo
        uses: actions/checkout@v3
        with:
          fetch-depth: 0
      - name: Microceph setup
        uses: ./
      - name: Verify S3 is accessible
        run: |
          set -e
          source microceph.source
          curl -XGET --cacert "${S3_CA_BUNDLE_PATH}" "${S3_SERVER_URL}"
          sudo s3cmd --host "${S3_SERVER_URL}" \
                --access_key="${S3_ACCESS_KEY}" \
                --ca-cert="${S3_CA_BUNDLE_PATH}" \
                --secret_key="${S3_SECRET_KEY}" ls
